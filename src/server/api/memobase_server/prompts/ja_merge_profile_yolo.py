from .utils import pack_merge_action_into_string
from ..env import CONFIG

ADD_KWARGS = {"prompt_id": "ja_merge_profile_yolo"}

MERGE_FACTS_PROMPT = """あなたは、ユーザーのメモをメンテナンスする責務を負っています。
あなたの仕事は、新しい補足情報を現在のメモとどのように統合するか？を判断することです。
ユーザーは一連のメモトピック/サブトピック、トピックの説明、および具体的な更新要件（空の場合あり）を提供します。
各補足情報について、新しい情報を直接追加するか、現在の対応するメモを更新するか、または破棄するかを判断する必要があります。

## 入力フォーマット
```
{{
    "memo_id": "1",
    "new_info": "",
    "current_memo": "",
    "topic": "",
    "subtopic": "",
    "topic_description": "",
    "update_instruction": "",
}}
{{
    "memo_id": "2",
    ...
}}
...
```
各メモを評価する際には、それがトピックと更新内容の説明に沿っているかどうかを考慮する必要があります。

あなたの出力アクションは以下の通りです:
1. 直接追加: 補足情報が新たな知見を提供する場合は、直接追加してください。現在のメモが空の場合、補足情報を直接追加してください。
2. メモの更新: 補足情報が現在のメモと矛盾する場合、または現在の情報をより適切に反映するために現在のメモを修正する必要がある場合は、メモを更新してください。
3. 統合の放棄: 補足情報に価値がない場合、情報が現在のメモで完全に網羅されている場合、または現在のメモのコンテンツ要件を満たさない場合は、統合を放棄してください。

## 思考
出力アクションを行う前に、以下について思考してください：
1. 補足情報がメモのトピック説明に沿っているか？
    1.1. 要件に沿っている場合は、補足情報を修正してメモの要件を満たす内容にできるかどうかを判断し、修正した補足情報を処理してください
    1.2. トピックの説明を満たすように補足情報を修正できない場合は、統合を破棄してください。
3. 補足情報が現在のメモの要件を満たしている場合は、上記の説明に従って出力アクションを判断してください
4. メモの更新を選択した場合、現在のメモに簡略化または削除できる部分がないかも同時に検討してください。

追加事項:
1. 現在のメモが空の場合、思考ステップ1を行い、補足情報が要件を満たしていれば、直接追加してください。
2. 更新要件が空でない場合、ユーザーの更新要件を参照した上で、思考してください。

## 出力アクション
### 直接追加
```
N. APPEND{tab}APPEND
```
直接追加を選択した場合、シンプルに`APPEND`ワードを出力してください。コンテンツを繰り返す必要はありません。
### メモの更新
```
N. UPDATE{tab}[UPDATED_MEMO]
```
メモの更新を選択した場合、メモを更新して`[UPDATED_MEMO]`の中に完全に更新された現在のメモを書き直してください。
### 統合の放棄
```
N. ABORT{tab}ABORT
```
統合の放棄を選択した場合、シンプルに`ABORT`ワードを出力してください。コンテンツを繰り返す必要はありません。

## 出力フォーマット
上記の指示に従って、以下のフォーマットで出力してください:

THOUGHT
---
1. ACTION{tab}...
2. ACTION{tab}...
...

上記のうち:
- `THOUGHT` はあなたの思考プロセスです
- 思考とActionの間は `---` で区切られます
- `N. ACTION{tab}...` はN番目の補足情報（memo_id=N）に対する出力アクションです

## 例 
### 入力例
{{
    "memo_id": "1",
    "new_info": "期末試験の準備中[2025/06/01に言及]",
    "current_memo": "中間試験の準備中[2025/04/01に言及]",
    "topic": "学歴",
    "subtopic": "試験目標",
    "update_instruction": "目標を更新する際、古くなってしまった目標や矛盾した目標がないかを確認して、必要なら削除してください",
}}
{{
    "memo_id": "2",
    "new_info": "Duolingoで日本語を独学中",
    "current_memo": "",
    "topic": "学歴",
    "subtopic": "使用ソフトウェア",
}}
{{
    "memo_id": "3",
    "new_info": "ユーザーは鍋料理を食べるのが好き",
    "current_memo": "",
    "topic": "興味",
    "subtopic": "運動",
}}

### 出力例
```
補足情報には、ユーザーの現在の学習目標が期末試験の準備であることが記載されており、これはユーザーの学習目標を記録するというトピックの説明と一致しています。しかし、期末試験と中間試験が重複しているため、中間試験の目標を削除し、それを期末試験に更新する必要があります。
さらに、ユーザーは言語学習にDuolingoを利用していると述べており、ソフトウェア使用の要件を満たしています。メモID 2の現在のメモが空欄であるため、直接追加できます。
鍋料理が好きという事実は興味・スポーツには該当せず、この情報から潜在的な興味を導き出すことはできないため、統合を破棄する。
---
1. UPDATE{tab}期末試験の準備中[2025/06/01に言及];
2. APPEND{tab}APPEND
3. ABORT{tab}ABORT
```

## 要件
以下の指示に従ってください:
- 正しい出力形式を厳守してください。
- 更新されたメモは5文を超えないようにしてください。常に簡潔にまとめ、メモの要点を出力してください。
- 入力で言及されていない内容を捏造しないでください。
- 旧メモと新メモの両方の日時アノテーションを保持してください。（例: XXX[2025/05/05に言及、2022年に発生]）。
- 更新する場合は、最終メモが簡潔であり、冗長な情報を含んでいないことを確認してください（例: 「ユーザーは悲しい；ユーザーの気分は悲しい」==「ユーザーは悲しい」）。

以上が全ての内容です。では、作業を実行してください。
"""


def get_input(
    memos_list: list[dict],
):
    return f"""
{memos_list}
"""


def get_prompt() -> str:
    return MERGE_FACTS_PROMPT.format(
        tab=CONFIG.llm_tab_separator,
    )


def get_kwargs() -> dict:
    return ADD_KWARGS


if __name__ == "__main__":
    print(get_prompt())
